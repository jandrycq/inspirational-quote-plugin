name: Creates a release when a plugin is updated

on:
  push:
    branches:
      - trunk

jobs:
  make-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get plugin version from header file
        id: get_plugin_version
        run: echo "VERSION=$(grep "Version:" ${{ github.event.repository.name }}.php | awk '{print $3}')" >> "$GITHUB_OUTPUT"

      - name: Zip folder
        run: git archive --format=zip --output=${{ github.event.repository.name }}.zip HEAD -- .

      - name: Create release
        id: create_github_release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ github.event.repository.name }}.zip
          tag_name: v${{ steps.get_plugin_version.outputs.VERSION }}
          generate_release_notes: true
          make_latest: true

      - name: Delete auto-generated archives
        if: steps.create_github_release.outcome == 'success'
        run: |
          REPO="${{ github.repository }}"
          RELEASE_ID="${{ steps.create_github_release.outputs.id }}"
          ZIP_NAME="${{ github.event.repository.name }}-*.zip"
          TAR_GZ_NAME="${{ github.event.repository.name }}-*.tar.gz"
          curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$REPO/releases/$RELEASE_ID/assets?name=$ZIP_NAME"
          curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$REPO/releases/$RELEASE_ID/assets?name=$TAR_GZ_NAME"

permissions:
  contents: write
